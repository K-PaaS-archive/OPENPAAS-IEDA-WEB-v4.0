<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfDAO">

<resultMap id="cfInfo" type="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfVO">
    <id property="id" column="id"/>
    <result property="recid" column="id"/>
    <result property="iaasType" column="iaas_type"/>
    <result property="cfConfigName" column="cf_config_name"/>
    <result property="defaultConfigInfo" column="default_config_info"/>
    <result property="networkConfigInfo" column="network_config_info"/>
    <result property="resourceConfigInfo" column="resource_config_info"/>
    <result property="keyConfigInfo" column="key_config_info"/>
    <result property="instanceConfigInfo" column="instance_config_info"/>
    <result property="deploymentFile" column="deployment_file"/>
    <result property="deployStatus" column="deploy_status"/>
    <result property="taskId" column="task_id"/>
    
    <collection property="defaultConfigVO" ofType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfDefaultConfigVO"  javaType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfDefaultConfigVO">
        <result property="id" column="id" />
        <result property="recid" column="id"/>
        <result property="iaasType" column="IAAS_TYPE"/>
        <result property="defaultConfigName" column="default_config_name"/>
        <result property="deploymentName" column="deployment_name"/>
        <result property="directorId" column="director_id" />
        <result property="releaseName" column="release_name" />
        <result property="releaseVersion" column="release_version" />
        <result property="loggregatorReleaseName" column="loggregator_release_name" />
        <result property="loggregatorReleaseVersion" column="loggregator_release_version" />
        <result property="domain" column="domain" />
        <result property="domainOrganization" column="domain_organization" />
        <result property="loginSecret" column ="login_secret"/>
        <result property="ingestorIp" column ="ingestor_ip"/>
        <result property="paastaMonitoringUse" column ="paasta_monitoring_use"/>
        
    </collection>
    <collection property="keyConfigVO" ofType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfKeyConfigVO"  javaType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfKeyConfigVO">
        <result property="id" column="id" />
        <result property="keyConfigName" column="key_config_name"/>
        <result property="keyFileName" column="Key_file_name" />
    </collection>
    <collection property="resourceConfigVO" ofType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfResourceConfigVO"  javaType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfResourceConfigVO">
        <result property="id" column="id" />
        <result property="resourceConfigName" column="resource_config_name"/>
        <result property="boshPassword" column="bosh_password" />
        <result property="stemcellName" column="stemcell_name" />
        <result property="stemcellVersion" column="stemcell_version" />
        <result property="smallFlavor" column="small_flavor" />
        <result property="mediumFlavor" column="medium_flavor" />
        <result property="largeFlavor" column="large_flavor" />
    </collection>
    <collection property="instanceConfigVO"  ofType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfInstanceConfigVO" javaType="org.openpaas.ieda.hbdeploy.web.deploy.cf.dao.HbCfInstanceConfigVO" >
        <result property="id" column="id" />
        <result property="instanceConfigName" column="instance_config_name"/>
        <result property="nats_z1" column="nat_z1" />
        <result property="blobstore_z1" column="blobstore_z1" />
        <result property="router_z1" column="router_z1" />
        <result property="loggregator_z1" column="loggregator_z1" />
        <result property="doppler_z1" column="droppler_z1" />
        <result property="etcd_z1" column ="etcd_z1"/>
        <result property="consul_z1" column="consul_z1" />
        <result property="clock_z1" column="clock_z1" />
        <result property="api_z1" column="api_z1" />
        <result property="uaa_z1" column="uaa_z1" />
        <result property="api_worker_z1" column="api_worker_z1" />
        <result property="postgres_z1" column ="postgres_z1"/>
        <result property="nats_z2" column="nat_z2" />
        <result property="blobstore_z2" column="blobstore_z2" />
        <result property="router_z2" column="router_z2" />
        <result property="loggregator_z2" column="loggregator_z2" />
        <result property="doppler_z2" column="droppler_z2" />
        <result property="etcd_z2" column ="etcd_z2"/>
        <result property="consul_z2" column="consul_z2" />
        <result property="clock_z2" column="clock_z2" />
        <result property="api_z2" column="api_z2" />
        <result property="uaa_z2" column="uaa_z2" />
        <result property="api_worker_z2" column="api_worker_z2" />
        <result property="postgres_z2" column ="postgres_z2"/>
    </collection>
</resultMap>

<select id="selectHbCfInfoList" resultMap="cfInfo">
    select
        cf.id 
        ,cf.iaas_type
        ,cf.cf_config_name
        ,cf.default_config_info
        ,cf.network_config_info
        ,cf.key_config_info
        ,cf.resource_config_info
        ,cf.instance_config_info
        ,cf.deployment_file
        ,cf.deploy_status
        ,cf.task_id
        ,defaultInfo.id
        ,defaultInfo.default_config_name
        ,defaultInfo.director_id
        ,defaultInfo.release_name
        ,defaultInfo.release_version
        ,defaultInfo.deployment_name
        ,defaultInfo.loggregator_release_name
        ,defaultInfo.loggregator_release_version
        ,defaultInfo.login_secret
        ,defaultInfo.paasta_monitoring_use
        ,defaultInfo.domain_organization
        ,defaultInfo.domain
        ,defaultInfo.ingestor_ip
        
        ,keyInfo.key_config_name
        ,keyInfo.key_file_name
        
        ,resourceInfo.resource_config_name
        ,resourceInfo.bosh_password
        ,resourceInfo.stemcell_name
        ,resourceInfo.stemcell_version
        ,resourceInfo.small_flavor 
        ,resourceInfo.medium_flavor
        ,resourceInfo.large_flavor
        
        ,instanceInfo.nat_z1
        ,instanceInfo.blobstore_z1
        ,instanceInfo.router_z1
        ,instanceInfo.loggregator_z1
        ,instanceInfo.droppler_z1
        ,instanceInfo.etcd_z1
        ,instanceInfo.consul_z1
        ,instanceInfo.clock_z1
        ,instanceInfo.uaa_z1
        ,instanceInfo.api_z1
        ,instanceInfo.api_worker_z1
        ,instanceInfo.postgres_z1
        ,instanceInfo.nat_z2
        ,instanceInfo.blobstore_z2
        ,instanceInfo.router_z2
        ,instanceInfo.loggregator_z2
        ,instanceInfo.droppler_z2
        ,instanceInfo.etcd_z2
        ,instanceInfo.consul_z2
        ,instanceInfo.clock_z2
        ,instanceInfo.uaa_z2
        ,instanceInfo.api_z2
        ,instanceInfo.api_worker_z2
        ,instanceInfo.postgres_z2
        ,cf.update_user_id
        ,cf.update_date
        ,cf.update_user_id
        ,cf.update_date
    from ieda_cf_config as cf
    Left join ieda_cf_default_config as defaultInfo
    on cf.default_config_info = defaultInfo.default_config_name
    Left join ieda_cf_network_config as networkInfo
    on cf.network_config_info = networkInfo.network_config_name
    Left join ieda_cf_resource_config as resourceInfo
    on cf.resource_config_info = resourceInfo.resource_config_name
    Left join ieda_cf_key_config as keyInfo
    on cf.key_config_info = keyInfo.key_config_name
    Left join ieda_cf_instance_config as instanceInfo
    on cf.instance_config_info = instanceInfo.instance_config_name
    <if test="installStatus == 'installAble'">
    where deploy_status is null
    or deploy_status = '';
    </if>
    <if test="installStatus != 'installAble'">
    where deploy_status is not null
    or deploy_status != '';
    </if>
</select>
    
<select id="selectHbCfInfoById" resultMap="cfInfo">
    select
        cf.id 
        ,cf.iaas_type
        ,cf.cf_config_name
        ,cf.default_config_info
        ,cf.network_config_info
        ,cf.key_config_info
        ,cf.resource_config_info
        ,cf.instance_config_info
        ,cf.deployment_file
        ,cf.deploy_status
        ,cf.task_id
        ,defaultInfo.id
        ,defaultInfo.default_config_name
        ,defaultInfo.director_id
        ,defaultInfo.release_name
        ,defaultInfo.release_version
        ,defaultInfo.deployment_name
        ,defaultInfo.loggregator_release_name
        ,defaultInfo.loggregator_release_version
        ,defaultInfo.login_secret
        ,defaultInfo.paasta_monitoring_use
        ,defaultInfo.domain_organization
        ,defaultInfo.domain
        ,defaultInfo.ingestor_ip
        
        ,keyInfo.key_config_name
        ,keyInfo.key_file_name
        
        ,resourceInfo.resource_config_name
        ,resourceInfo.bosh_password
        ,resourceInfo.stemcell_name
        ,resourceInfo.stemcell_version
        ,resourceInfo.small_flavor 
        ,resourceInfo.medium_flavor
        ,resourceInfo.large_flavor
        
        ,instanceInfo.nat_z1
        ,instanceInfo.blobstore_z1
        ,instanceInfo.router_z1
        ,instanceInfo.loggregator_z1
        ,instanceInfo.droppler_z1
        ,instanceInfo.etcd_z1
        ,instanceInfo.consul_z1
        ,instanceInfo.clock_z1
        ,instanceInfo.uaa_z1
        ,instanceInfo.api_z1
        ,instanceInfo.api_worker_z1
        ,instanceInfo.postgres_z1
        ,instanceInfo.nat_z2
        ,instanceInfo.blobstore_z2
        ,instanceInfo.router_z2
        ,instanceInfo.loggregator_z2
        ,instanceInfo.droppler_z2
        ,instanceInfo.etcd_z2
        ,instanceInfo.consul_z2
        ,instanceInfo.clock_z2
        ,instanceInfo.uaa_z2
        ,instanceInfo.api_z2
        ,instanceInfo.api_worker_z2
        ,instanceInfo.postgres_z2
        ,cf.update_user_id
        ,cf.update_date
        ,cf.update_user_id
        ,cf.update_date
    from ieda_cf_config as cf
    Left join ieda_cf_default_config as defaultInfo
    on cf.default_config_info = defaultInfo.default_config_name
    Left join ieda_cf_network_config as networkInfo
    on cf.network_config_info = networkInfo.network_config_name
    Left join ieda_cf_resource_config as resourceInfo
    on cf.resource_config_info = resourceInfo.resource_config_name
    Left join ieda_cf_key_config as keyInfo
    on cf.key_config_info = keyInfo.key_config_name
    Left join ieda_cf_instance_config as instanceInfo
    on cf.instance_config_info = instanceInfo.instance_config_name
    where cf.id = #{id}
</select>
    
<insert id="insertHbCfInfo" useGeneratedKeys="true" keyColumn="id" keyProperty="vo.id">
    INSERT INTO ieda_cf_config (
        id
        ,iaas_type
        ,cf_config_name
        ,default_config_info
        ,network_config_info
        ,key_config_info
        ,resource_config_info
        ,instance_config_info
        ,deployment_file
        ,create_user_id
        ,create_date
        ,update_user_id
        ,update_date
     )VALUE (
         #{vo.id}
        ,#{vo.iaasType}
        ,#{vo.cfConfigName}
        ,#{vo.defaultConfigInfo}
        ,#{vo.networkConfigInfo}
        ,#{vo.keyConfigInfo}
        ,#{vo.resourceConfigInfo}
        ,#{vo.instanceConfigInfo}
        ,#{vo.deploymentFile}
        ,#{vo.createUserId}
        ,now()
        ,#{vo.updateUserId}
        ,now()
      )
       <selectKey keyProperty="vo.id" resultType="int" order="AFTER">
        <if test="vo.id != 1"> SELECT LAST_INSERT_ID(); </if>
        <if test="vo.id == 1"> SELECT 1 AS id from dual; </if>
        </selectKey>
</insert>
    
<update id="updateHbCfInfo">
    Update ieda_cf_config set
        iaas_type = #{vo.iaasType}
        ,cf_config_name = #{vo.cfConfigName}
        ,default_config_info = #{vo.defaultConfigInfo}
        ,network_config_info = #{vo.networkConfigInfo}
        ,key_config_info = #{vo.keyConfigInfo}
        ,resource_config_info = #{vo.resourceConfigInfo}
        ,instance_config_info = #{vo.instanceConfigInfo}
        ,deployment_file = #{vo.deploymentFile}
        ,deploy_status = #{vo.deployStatus}
        ,task_id = #{vo.taskId}
        ,update_user_id = #{vo.updateUserId}
        ,update_date = now()
    WHERE
    id=#{vo.id}
</update>

<select id = "selectHbCfInfoByName" resultType="int">
    select 
         count(*)
    from ieda_cf_config
    where cf_config_name = #{cfConfigName}
</select>

<delete id="deleteHbCfInfo">
    Delete 
    From ieda_cf_config
    Where id=#{id}
</delete>


</mapper>